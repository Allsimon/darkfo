<html>
<head>
<title>heart.js test</title>
<script src="heart.js"></script>
<script src="jquery-1.11.1.min.js"></script>
<script>
var MAP_NAME = "derp_walls2"
var matrix = null
var gObjects = []
var size = 6
var tile_width = 80
var tile_height = 36
var images = {}
var imageOffsets = {}
//var cameraX = 3375
//var cameraY = 105
// var cameraX = 3640
// var cameraY = 1560
var cameraX = 3490
var cameraY = 1200
var showHexOverlay = false

// tile grid geometry info
var transX = 48, transY = 24
var xdx = transX
var ydy = transY
var xdy = ydy - tile_height
var ydx = tile_width - xdx

function tileToScreen(x, y) {
	x = 99 - x // this algorithm expects x to be reversed
	var sx = 4752 + (32 * y) - (48 * x)
	var sy = (24 * y) + (12 * x)

   return {x: sx, y: sy}
}

function tileFromScreen(x, y) {
	var determinant = xdx*ydy - xdy*ydx
	var tx = (x * ydy + y * -ydx) / determinant
	var ty = (x * -xdy + y * xdx) / determinant

	return {x: Math.round(tx), y: Math.round(ty) - 1}
}

// hex grid geometry info
var hexTileW = 32
var hexTileH = 16
var hexTransX = 16
var hexTransY = 12
var _hexOffsetX = 32
var _hexOffsetY = 10
var hexOffsetX = 0
var hexOffsetY = 0

// function hexToScreen(x, y) {
// 	var dx = hexTransX, dy = hexTransY

// 	var sx = hexOffsetX - (x*hexTileW - (x/2)*dx - y * hexTileH)
// 	var sy = hexOffsetY + (x/2)*dy + y*dy

// 	//if(x%2==0) sx += hexTileW/2;
// 	//if(x%2==0) sy += hexTileH/2;

// 	return {x: sx, y: sy}
// }

// function hexFromScreen(x, y) {
// 	var mx = (x - hexOffsetX) / -hexTransX
// 	var my = (y - hexOffsetY) / hexTransY

// 	var hexX = Math.floor((mx + my + 1) / 2)
// 	var hexY = Math.floor(Math.floor(my) - hexX/2)

// 	return {x: hexX, y: hexY}
// }

// var _h = hexToScreen(200 /* map size */ - 1, 0)
// hexOffsetX = _hexOffsetX - _h.x
// hexOffsetY = _hexOffsetY - _h.y

function hexToScreen(x, y) {
	//console.log(x + ", " + y)
	var sx = 4816 - ((((x + 1) >> 1) << 5 )+ ((x >> 1) << 4) - (y << 4)); //ver1
	var sy = ((12 * (x >> 1)) + (y * 12)) + 11; // + 8

	return {x: sx, y: sy}
}


function hexFromScreen(x, y) {
	return {x: 0, y: 0}
}

var hexOverlay = null

// 200x200 hex grid
var hexMatrix = []
for(var i = 0; i < 200; i++) {
	var t = [];
	for(var j = 0; j < 200; j++)
		t.push(0);
	hexMatrix.push(t);
}

var cursor = {x: 10, y: 10}

heart.preload = function() {
	function load(file) {
		heart.graphics.newImage(file+".png", function(r) { images[file] = r; })
	}

	$.ajaxSetup({async: false})

	var loadImages = null
	$.get(MAP_NAME + ".images.json", function(images_) { loadImages = images_ }, "json")

	for(var i = 0; i < loadImages.length; i++)
		load(loadImages[i])
	console.log("loaded " + loadImages.length + " tiles")

	var loadOffsets = null
	$.get(MAP_NAME + ".offsets.json", function(offsets) { loadOffsets = offsets }, "json")

	var numOffsets = 0
	for(var image in loadOffsets) {
		imageOffsets[image] = loadOffsets[image]
		numOffsets++
	}

	console.log("loaded " + numOffsets + " offsets")
	heart.graphics.newImage("hex_outline.png", function(r) { hexOverlay = r })
}

heart.load = function() {
	heart.attach("cnv");
	$.get(MAP_NAME+".json", function(map) {
		matrix = map["tiles"]
		gObjects = map["objects"]
		console.log("loaded (" + matrix.length + " tiles, " + gObjects.length + " objects)")
	}, "json")
}

heart.keydown = function(k) {
	if(k == 'down') cameraY += 15
	if(k == 'right') cameraX += 15
	if(k == 'left') cameraX -= 15
	if(k == 'up') cameraY -= 15
}

heart.draw = function() {
	heart.graphics.setColor(255, 255, 255)

	var mousePos = heart.mouse.getPosition()
	var mouseHex = hexFromScreen(mousePos[0] + cameraX, mousePos[1] + cameraY)
	var mouseTile = tileFromScreen(mousePos[0] + cameraX, mousePos[1] + cameraY)

	// draw tile grid
	if(matrix === null) return;
	for(var i = 0; i < matrix.length; i++) {
		for(var j = 0; j < matrix[0].length; j++) {
			var tile = matrix[j][i]
			var x = i
			var y = j
			var img = "art/tiles/" + tile

			if(images[img] !== undefined) {
				var scr = tileToScreen(x, y)
				heart.graphics.draw(images[img], scr.x - cameraX, scr.y - cameraY)
			}
		}
	}

	// draw hex grid overlay
	if(showHexOverlay) {
		for(var i = 0; i < hexMatrix.length; i++) {
			for(var j = 0; j < hexMatrix[0].length; j++) {
				var scr = hexToScreen(i, j)
				heart.graphics.draw(hexOverlay, scr.x - 16 - cameraX, scr.y - 12 - cameraY)
				if(i == mouseHex.x && j == mouseHex.y) {
					heart.graphics.print("m", scr.x - 3 - cameraX, scr.y - 3 - cameraY)
				}
			}
		}
	} else {
		var scr = hexToScreen(mouseHex.x, mouseHex.y)
		heart.graphics.draw(hexOverlay, scr.x - 16 - cameraX, scr.y - 12 - cameraY)
	}

	// draw objects
	for(var i = 0; i < gObjects.length; i++) {
		var obj = gObjects[i]
		var scr = hexToScreen(obj.position.x, obj.position.y)

		if(images[obj.art] === undefined)
			continue; // skip images we don't have

		var offsetX = Math.floor(images[obj.art].getWidth() / 2)
		var offsetY = images[obj.art].getHeight()

		if(imageOffsets[obj.art] !== undefined) {
			offsetX -= imageOffsets[obj.art].x;
			offsetY -= imageOffsets[obj.art].y;
		}

		// if(obj.position.x == 94 && obj.position.y == 81) {
		// 	console.log("scr=" + scr.x + "," + scr.y + "; off=" + imageOffsets[obj.art].x + "," + imageOffsets[obj.art].y + "; size=" +
		// 		images[obj.art].getWidth() + "," + images[obj.art].getHeight() +
		// 		"; oscr=" + (scr.x - offsetX - cameraX) + "," + (scr.y - offsetY - cameraY));
		// 	throw "ok";
		// }

		heart.graphics.draw(images[obj.art], scr.x - offsetX - cameraX, scr.y - offsetY - cameraY)

		if(obj.position.x == mouseHex.x && obj.position.y == mouseHex.y)
			heart.graphics.print("tile: " + obj.art + " offset: " + offsetX + ", " + offsetY, 5, 30)
	}


	var tileImg = matrix[mouseTile.y][mouseTile.x]
	heart.graphics.print("tile: " + tileImg, 5, 60)

	var scr = tileToScreen(mouseTile.x, mouseTile.y)
	heart.graphics.print("X", scr.x - 3 - cameraX, scr.y - 3 - cameraY)
	heart.graphics.print("scr: " + scr.x + ", " + scr.y, scr.x - 3 - cameraX, scr.y - 10 - cameraY)

	heart.graphics.print("mh: " + mouseHex.x + "," + mouseHex.y, 5, 15)
	heart.graphics.print("mt: " + mouseTile.x + "," + mouseTile.y, 100, 15)
}

</script>
</head>
<body>

<canvas id="cnv" width="800" height="600">your browser doesn't support &lt;canvas&gt;</canvas>

</body>
</html>