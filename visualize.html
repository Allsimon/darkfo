<html>
<head>
<title>heart.js test</title>
<script src="heart.js"></script>
<script src="jquery-1.11.1.min.js"></script>
<script>
var MAP_NAME = "SFChina"
var matrix = null
var gObjects = []
var size = 6
var tile_width = 80
var tile_height = 36
var images = {}
var cameraX = 3375
var cameraY = 105
var showHexOverlay = false

// tile grid geometry info
var transX = 48, transY = 24
var xdx = transX
var ydy = transY
var xdy = ydy - tile_height
var ydx = tile_width - xdx

function tileToScreen(x, y) {
	var sx = x * xdx + y * ydx + 0
	var sy = x * xdy + y * ydy + 0
	return {x: sx, y: sy}
}

// hex grid geometry info
var hexTileW = 32
var hexTileH = 16
var hexTransX = 16
var hexTransY = 12
var _hexOffsetX = 32
var _hexOffsetY = 10
var hexOffsetX = 0
var hexOffsetY = 0

function hexToScreen(x, y) {
	var dx = hexTransX, dy = hexTransY

	var sx = hexOffsetX - (x*hexTileW - (x/2)*dx - y * hexTileH)
	var sy = hexOffsetY + (x/2)*dy + y*dy

	return {x: sx, y: sy}
}

function hexFromScreen(x, y) {
	var mx = (x - hexOffsetX) / -hexTransX
	var my = (y - hexOffsetY) / hexTransY

	var hexX = Math.floor((mx + my + 1) / 2)
	var hexY = Math.floor(Math.floor(my) - hexX/2)

	return {x: hexX, y: hexY}
}

var _h = hexToScreen(200 /* map size */ - 1, 0)
hexOffsetX = _hexOffsetX - _h.x
hexOffsetY = _hexOffsetY - _h.y

var hexOverlay = null

// 200x200 hex grid
var hexMatrix = []
for(var i = 0; i < 200; i++) {
	var t = [];
	for(var j = 0; j < 200; j++)
		t.push(0);
	hexMatrix.push(t);
}

var cursor = {x: 10, y: 10}

var offsets = {
	"art/walls/fns1000": {x: 8, y: 12},
	"art/walls/fns1002": {x: 0, y: 12},
	"art/walls/fns2000": {x: -8, y: 0},
	"art/walls/vb4003": {x: -7, y: 2},
	"art/walls/vcn3000": {x: 0, y: 6},
	"art/walls/va1000": {x: 0, y: 6},
	"art/walls/va2001": {x: 8, y: 10},

	"art/walls/temple33": {x: 26, y: 8},
	"art/walls/temple34": {x: -17, y: 14},
	"art/walls/temple35": {x: 8, y: 4},
	"art/walls/temple36": {x: -16, y: 14},

	//
    "art/walls/vcn6000": {x: 0, y: 13},
    "art/scenery/weed01": {x: 10, y: 2},
    "art/scenery/weed03": {x: 0, y: 4},
    "art/scenery/weed02": {x: -2, y: 3},
    "art/scenery/weed04": {x: -1, y: 1},
    "art/scenery/weed07": {x: -27, y: 19},
    "art/scenery/doorcomp": {x: 10, y: -6},
    "art/misc/exitgrd8": {x: -24, y: 12},
    "art/scenery/rock01": {x: -1, y: 13},
    "art/walls/ca028": {x: 8, y: 3},
    "art/scenery/rock03": {x: -4, y: 25},
    "art/scenery/rock02": {x: 4, y: 13},
    "art/scenery/rock05": {x: 2, y: 19},
    "art/scenery/rock04": {x: 0, y: 21},
    "art/scenery/rock06": {x: 4, y: 26},
    "art/walls/vb3001": {x: -7, y: 2},
    "art/walls/vb3000": {x: -7, y: 2},
    "art/walls/ca023": {x: -8, y: 12},
    "art/walls/ca022": {x: -8, y: 8},
    "art/walls/ca025": {x: 0, y: 5},
    "art/walls/ca024": {x: -8, y: 7},
    "art/walls/ca027": {x: 0, y: 23},
    "art/walls/ca026": {x: 8, y: -6},
    "art/scenery/bone04": {x: 0, y: 8},
    "art/walls/ca036": {x: -16, y: 10},
    "art/walls/ca037": {x: 0, y: 11},
    "art/walls/ca032": {x: -1, y: 9},
    "art/walls/ca038": {x: 0, y: 9},
    "art/walls/ca039": {x: 0, y: 8},
    "art/scenery/weed23": {x: -10, y: -3},
    "art/scenery/weed22": {x: -10, y: 0},
    "art/scenery/weed21": {x: -11, y: -3},
    "art/scenery/weed20": {x: -3, y: 1},
    "art/scenery/weed26": {x: 16, y: -2},
    "art/scenery/weed25": {x: 19, y: 1},
    "art/scenery/weed24": {x: 17, y: -1},
    "art/walls/vcn4000": {x: 5, y: 16},
    "art/scenery/v13secur": {x: 4, y: 22},
    "art/walls/ca043": {x: 0, y: 9},
    "art/walls/ca042": {x: 0, y: 12},
    "art/walls/ca041": {x: 0, y: 11},
    "art/walls/ca040": {x: 0, y: 10},
    "art/walls/ca047": {x: 8, y: 13},
    "art/walls/ca046": {x: 0, y: 2},
    "art/walls/ca045": {x: 0, y: 5},
    "art/walls/ca044": {x: 0, y: 9},
    "art/walls/ca048": {x: 0, y: 18},
    "art/walls/vb4000": {x: -7, y: 2},
    "art/walls/vb4003": {x: -7, y: 2},
    "art/walls/block": {x: 0, y: 0},
    "art/walls/ca050": {x: 8, y: -9},
    "art/walls/ca053": {x: 0, y: 8},
    "art/walls/ca054": {x: 8, y: 12},
    "art/walls/ca055": {x: 0, y: 8},
    "art/walls/ca056": {x: 8, y: 12},
    "art/walls/ca057": {x: 0, y: 7},
    "art/walls/ca058": {x: 8, y: 11},
    "art/walls/ca059": {x: -8, y: -1},
    "art/walls/ca060": {x: -8, y: 0},
    "art/walls/ca063": {x: -1, y: 0},
    "art/walls/ca069": {x: 0, y: 11},
    "art/walls/ca068": {x: 0, y: 11},
    "art/walls/ca065": {x: 0, y: 11},
    "art/walls/ca064": {x: -1, y: 36},
    "art/walls/ca067": {x: 0, y: 11},
    "art/walls/ca066": {x: 0, y: 11},
    "art/walls/ca061": {x: -8, y: 0},
    "art/scenery/cstalag2": {x: -1, y: 10},
    "art/scenery/cstalag1": {x: 0, y: 8},
    "art/walls/ca062": {x: -8, y: 0},
    "art/scenery/cvcolum2": {x: 1, y: 4},
    "art/scenery/cvcolum1": {x: 0, y: 9},
    "art/walls/va5001": {x: 8, y: 10},
    "art/walls/ca021": {x: -8, y: 15},
    "art/walls/ca020": {x: -8, y: 15},
    "art/walls/ca072": {x: -13, y: 10},
    "art/walls/ca070": {x: 0, y: 11},
    "art/walls/ca071": {x: -4, y: 7},
    "art/misc/ext2grd8": {x: -24, y: 12},
    "art/misc/ext2grd5": {x: -32, y: 24},
    "art/misc/ext2grd3": {x: 0, y: 83},
    "art/misc/ext2grd1": {x: -32, y: 11},
    "art/scenery/v13secr3": {x: 60, y: 79},
    "art/scenery/v13secr2": {x: 73, y: 46},
    "art/misc/block": {x: 0, y: 0},
    "art/walls/vcn3000": {x: 0, y: 6},
    "art/walls/ca009": {x: 0, y: 5},
    "art/walls/ca008": {x: 8, y: 11},
    "art/walls/ca007": {x: 0, y: 9},
    "art/walls/ca006": {x: 8, y: 12},
    "art/walls/ca005": {x: 0, y: 4},
    "art/walls/ca004": {x: 8, y: 12},
    "art/walls/ca003": {x: 0, y: 10},
    "art/walls/ca002": {x: 8, y: 11},
    "art/scenery/weed18": {x: -6, y: -3},
    "art/scenery/weed19": {x: -5, y: 1},
    "art/scenery/weed12": {x: 20, y: 4},
    "art/scenery/weed13": {x: 23, y: 3},
    "art/scenery/weed11": {x: 20, y: 4},
    "art/scenery/block": {x: 0, y: 0},
    "art/scenery/bone01": {x: 4, y: 12},
    "art/scenery/bone02": {x: 3, y: 12},
    "art/walls/ca018": {x: -8, y: 11},
    "art/walls/ca019": {x: -8, y: 11},
    "art/walls/ca014": {x: -8, y: 12},
    "art/walls/ca015": {x: 0, y: 21},
    "art/walls/ca016": {x: -8, y: 10},
    "art/walls/ca017": {x: -8, y: 8},
    "art/walls/ca010": {x: 8, y: 11},
    "art/walls/ca011": {x: 0, y: 18},
    "art/walls/ca012": {x: 8, y: 8},
    "art/walls/ca013": {x: 0, y: 13}
}

heart.preload = function() {
	function load(file) {
		heart.graphics.newImage(file+".png", function(r) { images[file] = r; })
	}

	$.ajaxSetup({async: false})

	var loadImages = null
	$.get(MAP_NAME + ".images.json", function(images_) { loadImages = images_ }, "json")

	for(var i = 0; i < loadImages.length; i++)
		load(loadImages[i])

	heart.graphics.newImage("hex_outline.png", function(r) { hexOverlay = r })
}

heart.load = function() {
	heart.attach("cnv");
	$.get(MAP_NAME+".json", function(data) {
		var map = JSON.parse(data)
		matrix = map["tiles"]
		gObjects = map["objects"]
		console.log("loaded (" + matrix.length + " tiles, " + gObjects.length + " objects)")
	})
}

heart.keydown = function(k) {
	if(k == 'down') cameraY += 15
	if(k == 'right') cameraX += 15
	if(k == 'left') cameraX -= 15
	if(k == 'up') cameraY -= 15
}

heart.draw = function() {
	heart.graphics.setColor(255, 255, 255)

	var mousePos = heart.mouse.getPosition()
	var mouseHex = hexFromScreen(mousePos[0] + cameraX, mousePos[1] + cameraY)

	// draw tile grid
	if(matrix === null) return;
	for(var i = 0; i < matrix.length; i++) {
		for(var j = 0; j < matrix[0].length; j++) {
			var tile = matrix[j][i]
			var x = 99-i
			var y = j
			var img = "art/tiles/" + tile

			if(images[img] !== undefined) {
				var scr = tileToScreen(x, y)
				heart.graphics.draw(images[img], scr.x - cameraX, scr.y - cameraY)
			}
			//else console.log(img)
		}
	}

	// draw objects
	for(var i = 0; i < gObjects.length; i++) {
		var obj = gObjects[i]
		var scr = hexToScreen(obj.position.x, obj.position.y)

		if(images[obj.art] === undefined)
			continue; // skip images we don't have

		var offsetX = images[obj.art].getWidth() / 2
		var offsetY = images[obj.art].getHeight()

		if(offsets[obj.art] !== undefined) {
			offsetX -= offsets[obj.art].x;
			offsetY -= offsets[obj.art].y;
		}

		heart.graphics.draw(images[obj.art], scr.x - offsetX - cameraX, scr.y - offsetY - cameraY)

		if(obj.position.x == mouseHex.x && obj.position.y == mouseHex.y)
			heart.graphics.print("tile: " + obj.art, 5, 30)
	}

	// draw hex grid overlay
	if(showHexOverlay) {
		for(var i = 0; i < hexMatrix.length; i++) {
			for(var j = 0; j < hexMatrix[0].length; j++) {
				var scr = hexToScreen(i, j)
				heart.graphics.draw(hexOverlay, scr.x - 16 - cameraX, scr.y - 12 - cameraY)
				if(i == mouseHex.x && j == mouseHex.y) {
					heart.graphics.print("m", scr.x - 3 - cameraX, scr.y - 3 - cameraY)
				}
			}
		}
	} else {
		var scr = hexToScreen(mouseHex.x, mouseHex.y)
		heart.graphics.draw(hexOverlay, scr.x - 16 - cameraX, scr.y - 12 - cameraY)
	}

	heart.graphics.print("mh: " + mouseHex.x + "," + mouseHex.y, 5, 15)
}

</script>
</head>
<body>

<canvas id="cnv" width="800" height="600">your browser doesn't support &lt;canvas&gt;</canvas>

</body>
</html>